# TrendRadar è‡ªåŠ¨éƒ¨ç½²åˆ° Hexo åšå®¢çš„ GitHub Actions å·¥ä½œæµç¤ºä¾‹
# 
# æ­¤æ–‡ä»¶å±•ç¤ºå¦‚ä½•å°† TrendRadar ç”Ÿæˆçš„å†…å®¹è‡ªåŠ¨æŽ¨é€åˆ° Hexo åšå®¢ä»“åº“
# 
# ä½¿ç”¨æ–¹æ³•ï¼š
# 1. å°†æ­¤æ–‡ä»¶çš„å†…å®¹æ·»åŠ åˆ° .github/workflows/crawler.yml çš„æœ€åŽ
# 2. åœ¨ GitHub åˆ›å»º Personal Access Tokenï¼ˆéœ€è¦ repo æƒé™ï¼‰
# 3. åœ¨ TrendRadar ä»“åº“çš„ Settings â†’ Secrets â†’ Actions ä¸­æ·»åŠ  HEXO_REPO_TOKEN
# 4. ä¿®æ”¹ä¸‹é¢çš„ conf-haolee/conf-haolee.github.io ä¸ºæ‚¨çš„åšå®¢ä»“åº“åœ°å€
# 5. ç¡®ä¿æ‚¨çš„ Hexo é…ç½®æ–‡ä»¶ä¸­å·²æ·»åŠ  skip_render: - trendradar/**

name: Deploy TrendRadar to Hexo Blog

# åœ¨ä¸» crawler å·¥ä½œæµä¹‹åŽæ·»åŠ æ­¤æ­¥éª¤
jobs:
  deploy-to-hexo:
    runs-on: ubuntu-latest
    needs: crawl  # ä¾èµ–ä¸»çˆ¬è™«ä»»åŠ¡å®Œæˆ
    
    steps:
      - name: Checkout TrendRadar repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ä»¥ä¾¿å¤åˆ¶æ‰€æœ‰æ–‡ä»¶
      
      - name: Clone Hexo blog repository
        env:
          HEXO_REPO_TOKEN: ${{ secrets.HEXO_REPO_TOKEN }}
        run: |
          echo "ðŸ“¦ å…‹éš† Hexo åšå®¢ä»“åº“..."
          # å°†ä¸‹é¢çš„ä»“åº“åœ°å€æ›¿æ¢ä¸ºæ‚¨çš„ Hexo åšå®¢ä»“åº“
          git clone https://${HEXO_REPO_TOKEN}@github.com/YOUR_USERNAME/YOUR_BLOG_REPO.git hexo-blog
      
      - name: Copy TrendRadar files to Hexo
        run: |
          echo "ðŸ“‹ å¤åˆ¶ TrendRadar æ–‡ä»¶..."
          
          # åˆ›å»º trendradar ç›®å½•
          mkdir -p hexo-blog/source/trendradar
          
          # å¤åˆ¶ä¸»é¡µé¢
          cp index.html hexo-blog/source/trendradar/
          
          # å¤åˆ¶è¾“å‡ºç›®å½•ï¼ˆåŒ…å«åŽ†å²æ•°æ®ï¼‰
          if [ -d "output" ]; then
            cp -r output hexo-blog/source/trendradar/
          fi
          
          # å¤åˆ¶å›¾ç‰‡èµ„æºï¼ˆå¦‚æžœæœ‰ï¼‰
          if [ -d "_image" ]; then
            cp -r _image hexo-blog/source/trendradar/
          fi
          
          echo "âœ… æ–‡ä»¶å¤åˆ¶å®Œæˆ"
          
      - name: Create .nojekyll file
        run: |
          # ç¡®ä¿ GitHub Pages ä¸ä¼šå¿½ç•¥ä¸‹åˆ’çº¿å¼€å¤´çš„æ–‡ä»¶å¤¹
          touch hexo-blog/source/trendradar/.nojekyll
      
      - name: Commit and push to Hexo blog
        working-directory: hexo-blog
        run: |
          echo "ðŸš€ æäº¤å¹¶æŽ¨é€åˆ° Hexo åšå®¢..."
          
          # é…ç½® Git
          git config user.name 'TrendRadar Bot'
          git config user.email 'bot@trendradar.com'
          
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹
          git add source/trendradar
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰æ–°çš„æ›´æ”¹"
          else
            # æäº¤æ›´æ”¹
            COMMIT_TIME=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')
            git commit -m "ðŸ”„ Update TrendRadar: ${COMMIT_TIME}"
            
            # æŽ¨é€åˆ°è¿œç¨‹ä»“åº“
            git push
            
            echo "âœ… TrendRadar å·²æˆåŠŸéƒ¨ç½²åˆ° Hexo åšå®¢"
          fi
      
      - name: Summary
        run: |
          echo "================================================"
          echo "âœ¨ TrendRadar éƒ¨ç½²å®Œæˆï¼"
          echo "================================================"
          echo "è®¿é—®åœ°å€: https://YOUR_USERNAME.github.io/trendradar/"
          echo "æ³¨æ„ï¼šå°† YOUR_USERNAME æ›¿æ¢ä¸ºæ‚¨çš„ GitHub ç”¨æˆ·å"
          echo "================================================"

# ============================================
# å®Œæ•´çš„é›†æˆç¤ºä¾‹ï¼ˆæ›¿æ¢æ•´ä¸ª crawler.ymlï¼‰
# ============================================

# name: Hot News Crawler with Hexo Deployment
# 
# on:
#   schedule:
#     - cron: "0 * * * *"
#   workflow_dispatch:
# 
# permissions:
#   contents: write
# 
# jobs:
#   crawl:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v3
#       
#       - name: Set up Python
#         uses: actions/setup-python@v4
#         with:
#           python-version: "3.10"
#       
#       - name: Install dependencies
#         run: |
#           python -m pip install --upgrade pip
#           pip install -r requirements.txt
#       
#       - name: Verify required files
#         run: |
#           echo "ðŸ” æ£€æŸ¥å¿…éœ€çš„é…ç½®æ–‡ä»¶..."
#           if [ ! -f config/config.yaml ]; then
#             echo "âŒ é”™è¯¯: config/config.yaml æ–‡ä»¶ä¸å­˜åœ¨"
#             exit 1
#           fi
#           if [ ! -f config/frequency_words.txt ]; then
#             echo "âŒ é”™è¯¯: config/frequency_words.txt æ–‡ä»¶ä¸å­˜åœ¨"
#             exit 1
#           fi
#           echo "âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥é€šè¿‡"
#       
#       - name: Run crawler
#         env:
#           FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
#           TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
#           TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
#           DINGTALK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK_URL }}
#           WEWORK_WEBHOOK_URL: ${{ secrets.WEWORK_WEBHOOK_URL }}
#           WEWORK_MSG_TYPE: ${{ secrets.WEWORK_MSG_TYPE }}
#           EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
#           EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
#           EMAIL_TO: ${{ secrets.EMAIL_TO }}
#           EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER }}
#           EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
#           NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
#           NTFY_SERVER_URL: ${{ secrets.NTFY_SERVER_URL }}
#           NTFY_TOKEN: ${{ secrets.NTFY_TOKEN }}
#           GITHUB_ACTIONS: true
#         run: python main.py
#       
#       - name: Commit and push if changes
#         run: |
#           git config --global user.name 'GitHub Actions'
#           git config --global user.email 'actions@github.com'
#           git add -A
#           git diff --quiet && git diff --staged --quiet || (git commit -m "Auto update by GitHub Actions at $(TZ=Asia/Shanghai date)" && git push)
#   
#   deploy-to-hexo:
#     runs-on: ubuntu-latest
#     needs: crawl
#     steps:
#       - name: Checkout TrendRadar repository
#         uses: actions/checkout@v3
#       
#       - name: Clone Hexo blog repository
#         env:
#           HEXO_REPO_TOKEN: ${{ secrets.HEXO_REPO_TOKEN }}
#         run: |
#           # å°†ä¸‹é¢çš„ä»“åº“åœ°å€æ›¿æ¢ä¸ºæ‚¨çš„ Hexo åšå®¢ä»“åº“
#           git clone https://${HEXO_REPO_TOKEN}@github.com/YOUR_USERNAME/YOUR_BLOG_REPO.git hexo-blog
#       
#       - name: Copy and deploy
#         working-directory: hexo-blog
#         run: |
#           mkdir -p source/trendradar
#           cp ../index.html source/trendradar/
#           cp -r ../output source/trendradar/ 2>/dev/null || true
#           cp -r ../_image source/trendradar/ 2>/dev/null || true
#           touch source/trendradar/.nojekyll
#           
#           git config user.name 'TrendRadar Bot'
#           git config user.email 'bot@trendradar.com'
#           git add source/trendradar
#           git commit -m "Update TrendRadar: $(TZ=Asia/Shanghai date)" || exit 0
#           git push
